events {}
http {
  # Backends (compose service names + internal ports)
  upstream coder3b  { server coder3b:8001; }
  upstream sitechat { server sitechat:8002; }
  upstream qwen7b   { server qwen7b-bnb4:8003; }

  map $http_authorization $auth_header { default $http_authorization; }

  server {
    listen 8000;

    # Pass Authorization header through to vLLM (for API key check)
    proxy_set_header Authorization $auth_header;
    proxy_set_header Content-Type "application/json";

    # Path routing: pick the model by URL prefix
    location /coder/  { proxy_pass http://coder3b; }
    location /chat/   { proxy_pass http://sitechat; }
    location /qwen7b/ { proxy_pass http://qwen7b; }

    # Optional default: send /v1/* to the chat model
    location /v1/     { proxy_pass http://sitechat; }
  }
}

